<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-03-22 Παρ 02:40 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Compare the different methods</title>
<meta name="author" content="dp" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Compare the different methods</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgbc2f793">1. Callable functions</a></li>
<li><a href="#org04947c4">2. The files</a>
<ul>
<li><a href="#orgcbd580e">2.1. The astropy data</a></li>
</ul>
</li>
<li><a href="#org7212ff9">3. Astropy Convolution</a>
<ul>
<li><a href="#org86e9222">3.1. Astropy Fast Fourier Transform (FFT).</a></li>
</ul>
</li>
<li><a href="#orgabcfd90">4. Python Maskfill</a></li>
<li><a href="#orgcf5c7d1">5. R-INLA</a></li>
<li><a href="#orgf051711">6. Comparisons</a>
<ul>
<li><a href="#org7bd2ccd">6.1. Astropy conv</a></li>
<li><a href="#orgdae72e6">6.2. Astropy fft</a></li>
<li><a href="#orgd936091">6.3. Maskfill</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
Here I will compare 3 methods of filling missing data of FITS files.
</p>

<ol class="org-ol">
<li>Astropy&rsquo;s Convolution</li>
<li>Python&rsquo;s Maskfill method</li>
<li>R-INLA</li>
</ol>
<div id="outline-container-orgbc2f793" class="outline-2">
<h2 id="orgbc2f793"><span class="section-number-2">1.</span> Callable functions</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-python" id="org7b4a974"><span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span style="color: #dcaeea;">threshold</span> = np.arange(<span style="color: #da8548; font-weight: bold;">0</span>,<span style="color: #da8548; font-weight: bold;">50</span>,<span style="color: #da8548; font-weight: bold;">10</span>)
<span style="color: #51afef;">return</span> threshold
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org6e0c7de"><span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt
<span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span style="color: #51afef;">from</span> astropy.io <span style="color: #51afef;">import</span> fits
<span style="color: #51afef;">from</span> astropy.visualization <span style="color: #51afef;">import</span> astropy_mpl_style


<span style="color: #dcaeea;">fig</span>, <span style="color: #dcaeea;">axes</span> = plt.subplots(<span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #da8548; font-weight: bold;">5</span>, figsize=(<span style="color: #da8548; font-weight: bold;">20</span>, <span style="color: #da8548; font-weight: bold;">12</span>))  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Adjust the number of subplots as needed</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Iterate over different thresholds</span>
<span style="color: #51afef;">for</span> idx, i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">enumerate</span>(threshold):
    <span style="color: #dcaeea;">filename</span> = <span style="color: #98be65;">"{}/filled_{}.fits"</span>.<span style="color: #c678dd;">format</span>(path,i)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the image data</span>
    <span style="color: #dcaeea;">img_data_filled</span> = fits.getdata(filename)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Plot the image</span>
    <span style="color: #dcaeea;">ax</span> = axes[<span style="color: #da8548; font-weight: bold;">0</span>,idx]
    <span style="color: #dcaeea;">im</span> = ax.imshow(img_data_filled, cmap=<span style="color: #98be65;">'viridis'</span>, origin=<span style="color: #98be65;">'lower'</span>, vmin=-<span style="color: #da8548; font-weight: bold;">2.0</span>, vmax=<span style="color: #da8548; font-weight: bold;">20.0</span>)
    ax.set_title(<span style="color: #98be65;">"Threshold {}"</span>.<span style="color: #c678dd;">format</span>(i))
    plt.colorbar(im, ax=ax, orientation=<span style="color: #98be65;">'vertical'</span>, label=<span style="color: #98be65;">'Intensity'</span>)
<span style="color: #5B6268;">######### </span><span style="color: #5B6268;">Iterate over different thresholds for the second row of subplots</span>
    <span style="color: #dcaeea;">filename</span> = <span style="color: #98be65;">"galactic_center_masked_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the image data</span>
    <span style="color: #dcaeea;">img_data_masked</span> = fits.getdata(filename)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Plot the image on the second row</span>
    <span style="color: #dcaeea;">ax</span> = axes[<span style="color: #da8548; font-weight: bold;">1</span>, idx]
    <span style="color: #dcaeea;">im</span> = ax.imshow(img_data_masked, cmap=<span style="color: #98be65;">'viridis'</span>, origin=<span style="color: #98be65;">'lower'</span>, vmin=-<span style="color: #da8548; font-weight: bold;">2.0</span>, vmax=<span style="color: #da8548; font-weight: bold;">20.0</span>)
    plt.colorbar(im, ax=ax, orientation=<span style="color: #98be65;">'vertical'</span>, label=<span style="color: #98be65;">'Intensity'</span>)

<span style="color: #5B6268;">######### </span><span style="color: #5B6268;">Iterate over different diffs for the third row of subplots</span>
    <span style="color: #dcaeea;">filename</span> = <span style="color: #98be65;">"{}/diffs_{}.fits"</span>.<span style="color: #c678dd;">format</span>(path,i)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the original image data</span>
    <span style="color: #dcaeea;">original</span> = fits.getdata(<span style="color: #98be65;">"galactic_center.fits"</span>)

    <span style="color: #dcaeea;">img_diffs</span> = original - img_data_filled

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Plot the image on the second row</span>
    <span style="color: #dcaeea;">ax</span> = axes[<span style="color: #da8548; font-weight: bold;">2</span>, idx]
    <span style="color: #dcaeea;">im</span> = ax.imshow(img_diffs, cmap=<span style="color: #98be65;">'viridis'</span>, origin=<span style="color: #98be65;">'lower'</span>, vmin=-<span style="color: #da8548; font-weight: bold;">2.0</span>, vmax=<span style="color: #da8548; font-weight: bold;">20.0</span>)
    ax.set_title(<span style="color: #98be65;">"Diff = Original - Filled({})"</span>.<span style="color: #c678dd;">format</span>(i))
    plt.colorbar(im, ax=ax, orientation=<span style="color: #98be65;">'vertical'</span>, label=<span style="color: #98be65;">'Intensity'</span>)
<span style="color: #5B6268;">######### </span><span style="color: #5B6268;">Save the Diffs</span>
    <span style="color: #dcaeea;">hdu</span> = fits.PrimaryHDU(img_diffs)

    hdu.writeto(filename,overwrite = <span style="color: #a9a1e1;">True</span>)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Adjust layout and display the figure</span>
fig.suptitle(<span style="color: #98be65;">"{}"</span>.<span style="color: #c678dd;">format</span>(title))
plt.tight_layout()
<span style="color: #dcaeea;">filename</span> = <span style="color: #98be65;">"visualizations/{}"</span>.<span style="color: #c678dd;">format</span>(title)
plt.savefig(filename)
plt.close()

<span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"[[./"</span>+filename+<span style="color: #98be65;">".png]]"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="org430a71d"><span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span style="color: #51afef;">from</span> skimage.metrics <span style="color: #51afef;">import</span> structural_similarity <span style="color: #51afef;">as</span> ssim
<span style="color: #51afef;">from</span> astropy.io <span style="color: #51afef;">import</span> fits
<span style="color: #51afef;">import</span> pandas <span style="color: #51afef;">as</span> pd
<span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the FITS images for the masked images</span>
<span style="color: #dcaeea;">masked_images</span> = [fits.getdata(<span style="color: #98be65;">'{}/filled_{}.fits'</span>.<span style="color: #c678dd;">format</span>(path,i)) <span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> np.arange(<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">50</span>, <span style="color: #da8548; font-weight: bold;">10</span>)]

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the corresponding original images</span>
<span style="color: #dcaeea;">original_images</span> = fits.getdata(f<span style="color: #98be65;">'galactic_center.fits'</span>)

<span style="color: #dcaeea;">filel</span> = <span style="color: #98be65;">"galactic_center.fits"</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Calculate MSE and SSIM for each comparison</span>
<span style="color: #dcaeea;">mse_values</span> = [np.mean((original_images - masked_images[i]) ** <span style="color: #da8548; font-weight: bold;">2</span>) <span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #c678dd;">len</span>(masked_images))]
<span style="color: #dcaeea;">ssim_values</span> = [ssim(original_images, masked_images[i], data_range=original_images.<span style="color: #c678dd;">max</span>() - original_images.<span style="color: #c678dd;">min</span>()) <span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">range</span>(<span style="color: #c678dd;">len</span>(masked_images))]

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Create a DataFrame to store the results</span>
<span style="color: #dcaeea;">data</span> = {<span style="color: #98be65;">'Comparison'</span>: np.arange(<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">50</span>, <span style="color: #da8548; font-weight: bold;">10</span>),
        <span style="color: #98be65;">'MSE'</span>: mse_values,
        <span style="color: #98be65;">'SSIM'</span>: ssim_values}
<span style="color: #dcaeea;">df</span> = pd.DataFrame(data)

</pre>
</div>



<div id="org315b0cb" class="figure">
<p><img src="./visualizations/name.png" alt="name.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org04947c4" class="outline-2">
<h2 id="org04947c4"><span class="section-number-2">2.</span> The files</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgcbd580e" class="outline-3">
<h3 id="orgcbd580e"><span class="section-number-3">2.1.</span> The astropy data</h3>
<div class="outline-text-3" id="text-2-1">
<p>
I will use the data from data.astropy.org. The reason for this is that we have a dense non homogeneous image and it will be good for testing
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt
<span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span style="color: #51afef;">from</span> astropy.convolution <span style="color: #51afef;">import</span> Gaussian2DKernel, convolve
<span style="color: #51afef;">from</span> astropy.io <span style="color: #51afef;">import</span> fits
<span style="color: #51afef;">from</span> astropy.utils.data <span style="color: #51afef;">import</span> get_pkg_data_filename
<span style="color: #51afef;">from</span> scipy.ndimage <span style="color: #51afef;">import</span> convolve <span style="color: #51afef;">as</span> scipy_convolve

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the data from data.astropy.org</span>
<span style="color: #dcaeea;">filename</span> = get_pkg_data_filename(<span style="color: #98be65;">'galactic_center/gc_msx_e.fits'</span>)
<span style="color: #dcaeea;">hdul</span> = fits.<span style="color: #c678dd;">open</span>(filename)

hdul.info()
<span style="color: #dcaeea;">data</span> = hdul[<span style="color: #da8548; font-weight: bold;">0</span>].data

<span style="color: #dcaeea;">zoom</span> = data[<span style="color: #da8548; font-weight: bold;">50</span>:<span style="color: #da8548; font-weight: bold;">90</span>, <span style="color: #da8548; font-weight: bold;">60</span>:<span style="color: #da8548; font-weight: bold;">100</span>] * 1e5


<span style="color: #dcaeea;">hdul_1</span> = fits.PrimaryHDU(zoom)
hdul_1.writeto(<span style="color: #98be65;">"galactic_center.fits"</span>,overwrite = <span style="color: #a9a1e1;">True</span>)

hdul.close()
</pre>
</div>


<p>
Scale the file to have reasonable numbers (this is mostly so that colorbars do not have too many digits). Also, we crop it so you can see individual pixels
</p>

<p>
Then we can mask it by setting the brightest pixels to NaN
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> threshold:
    <span style="color: #dcaeea;">img</span> = zoom.copy()
    <span style="color: #51afef;">if</span> i &gt; <span style="color: #da8548; font-weight: bold;">0</span>:
        <span style="color: #dcaeea;">img</span>[img &gt; i] = np.nan
    <span style="color: #dcaeea;">hdu</span> = fits.PrimaryHDU(img)
    <span style="color: #dcaeea;">filename</span> = <span style="color: #98be65;">"galactic_center_masked_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i)
    hdu.writeto(filename,overwrite = <span style="color: #a9a1e1;">True</span>)


<span style="color: #dcaeea;">ig</span>, <span style="color: #dcaeea;">axes</span> = plt.subplots(<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #c678dd;">len</span>(threshold), figsize=(<span style="color: #da8548; font-weight: bold;">20</span>, <span style="color: #da8548; font-weight: bold;">4</span>))  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Adjust the number of subplots as needed</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Iterate over different thresholds</span>
<span style="color: #51afef;">for</span> idx, i <span style="color: #51afef;">in</span> <span style="color: #c678dd;">enumerate</span>(np.arange(<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">50</span>, <span style="color: #da8548; font-weight: bold;">10</span>)):
    <span style="color: #dcaeea;">filename</span> = <span style="color: #98be65;">"galactic_center_masked_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load the image data</span>
    <span style="color: #dcaeea;">img_data</span> = fits.getdata(filename)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Plot the image</span>
    <span style="color: #dcaeea;">ax</span> = axes[idx]
    <span style="color: #dcaeea;">im</span> = ax.imshow(img_data, cmap=<span style="color: #98be65;">'viridis'</span>, origin=<span style="color: #98be65;">'lower'</span>, vmin=-<span style="color: #da8548; font-weight: bold;">2.0</span>, vmax=<span style="color: #da8548; font-weight: bold;">20.0</span>)
    ax.set_title(<span style="color: #98be65;">"Threshold {}"</span>.<span style="color: #c678dd;">format</span>(i))
    plt.colorbar(im, ax=ax, orientation=<span style="color: #98be65;">'vertical'</span>, label=<span style="color: #98be65;">'Intensity'</span>)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Adjust layout and display the figure</span>
plt.tight_layout()
<span style="color: #dcaeea;">filename</span> = <span style="color: #98be65;">"visualizations/masked_fits"</span>
plt.savefig(filename)
plt.close()

filename+<span style="color: #98be65;">".png"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7212ff9" class="outline-2">
<h2 id="org7212ff9"><span class="section-number-2">3.</span> Astropy Convolution</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt
<span style="color: #51afef;">from</span> astropy.convolution <span style="color: #51afef;">import</span> Gaussian2DKernel, convolve
<span style="color: #51afef;">from</span> astropy.io <span style="color: #51afef;">import</span> fits
<span style="color: #51afef;">from</span> scipy.ndimage <span style="color: #51afef;">import</span> convolve <span style="color: #51afef;">as</span> scipy_convolve
<span style="color: #51afef;">import</span> os

<span style="color: #dcaeea;">mypath</span> = <span style="color: #98be65;">"astropy_conv"</span>

<span style="color: #51afef;">if</span> <span style="color: #51afef;">not</span> os.path.exists(mypath):
    os.mkdir(mypath)

</pre>
</div>

<p>
We smooth with a Gaussian kernel with x<sub>stddev</sub>=1 (and y<sub>stddev</sub>=1). It is a 9x9 array.
Astropy&rsquo;s convolution replaces the NaN pixels with a kernel-weighted interpolation from their neighbors
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> threshold:
    <span style="color: #dcaeea;">data</span> = fits.<span style="color: #c678dd;">open</span>(<span style="color: #98be65;">"galactic_center_masked_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i))[<span style="color: #da8548; font-weight: bold;">0</span>].data

    <span style="color: #dcaeea;">kernel</span> = Gaussian2DKernel(x_stddev=<span style="color: #da8548; font-weight: bold;">1</span>)
    <span style="color: #dcaeea;">astropy_conv</span> = convolve(data, kernel)

    <span style="color: #dcaeea;">hdu</span> = fits.PrimaryHDU(astropy_conv)

    hdu.writeto(<span style="color: #98be65;">"astropy_conv/filled_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i),overwrite = <span style="color: #a9a1e1;">True</span>)
</pre>
</div>




<div id="orgd205ab7" class="figure">
<p><img src="./visualizations/Astropy's Convolution.png" alt="Astropy's Convolution.png" />
</p>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">Comparison</th>
<th scope="col" class="org-right">MSE</th>
<th scope="col" class="org-right">SSIM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0.0</td>
<td class="org-right">41.31836383457224</td>
<td class="org-right">0.9542151726989633</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">10.0</td>
<td class="org-right">175.0253853352854</td>
<td class="org-right">0.8284485435865382</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">20.0</td>
<td class="org-right">156.0987621112356</td>
<td class="org-right">0.8674916390963295</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">30.0</td>
<td class="org-right">146.6109666965225</td>
<td class="org-right">0.8866031019110286</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">40.0</td>
<td class="org-right">135.1704353934664</td>
<td class="org-right">0.9033264570664562</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-org86e9222" class="outline-3">
<h3 id="org86e9222"><span class="section-number-3">3.1.</span> Astropy Fast Fourier Transform (FFT).</h3>
<div class="outline-text-3" id="text-3-1">
<p>
This is much more efficient for larger kernels.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt
<span style="color: #51afef;">from</span> astropy.convolution <span style="color: #51afef;">import</span> Gaussian2DKernel, convolve_fft
<span style="color: #51afef;">from</span> astropy.io <span style="color: #51afef;">import</span> fits
<span style="color: #51afef;">from</span> scipy.ndimage <span style="color: #51afef;">import</span> convolve <span style="color: #51afef;">as</span> scipy_convolve
<span style="color: #51afef;">import</span> os

<span style="color: #dcaeea;">mypath</span> = <span style="color: #98be65;">"astropy_fft"</span>

<span style="color: #51afef;">if</span> <span style="color: #51afef;">not</span> os.path.exists(mypath):
    os.mkdir(mypath)

<span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> threshold:
    <span style="color: #dcaeea;">data</span> = fits.<span style="color: #c678dd;">open</span>(<span style="color: #98be65;">"galactic_center_masked_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i))[<span style="color: #da8548; font-weight: bold;">0</span>].data

    <span style="color: #dcaeea;">kernel</span> = Gaussian2DKernel(x_stddev=<span style="color: #da8548; font-weight: bold;">1</span>)
    <span style="color: #dcaeea;">astropy_conv</span> = convolve(data, kernel)

    <span style="color: #dcaeea;">hdu</span> = fits.PrimaryHDU(astropy_conv)

    hdu.writeto(<span style="color: #98be65;">"astropy_fft/filled_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i),overwrite = <span style="color: #a9a1e1;">True</span>)
</pre>
</div>




<div id="org5e7c7ef" class="figure">
<p><img src="./visualizations/Astropy's FFT Convolution.png" alt="Astropy's FFT Convolution.png" />
</p>
</div>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-orgabcfd90" class="outline-2">
<h2 id="orgabcfd90"><span class="section-number-2">4.</span> Python Maskfill</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> subprocess

<span style="color: #51afef;">def</span> <span style="color: #c678dd;">run_poetry_command</span>(command):
    <span style="color: #51afef;">try</span>:
        <span style="color: #dcaeea;">result</span> = subprocess.run(command, shell=<span style="color: #a9a1e1;">True</span>, capture_output=<span style="color: #a9a1e1;">True</span>, text=<span style="color: #a9a1e1;">True</span>)
        <span style="color: #51afef;">if</span> result.returncode == <span style="color: #da8548; font-weight: bold;">0</span>:
            <span style="color: #51afef;">return</span> result.stdout
        <span style="color: #51afef;">else</span>:
            <span style="color: #51afef;">return</span> result.stderr
    <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
        <span style="color: #51afef;">return</span> <span style="color: #c678dd;">str</span>(e)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Example: Install dependencies</span>
<span style="color: #dcaeea;">install_command</span> = <span style="color: #98be65;">"poetry install"</span>
<span style="color: #dcaeea;">install_output</span> = run_poetry_command(install_command)
<span style="color: #c678dd;">print</span>(install_output)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Example: Add a package</span>
<span style="color: #dcaeea;">add_command</span> = <span style="color: #98be65;">"poetry add package_name"</span>
<span style="color: #dcaeea;">add_output</span> = run_poetry_command(add_command)
<span style="color: #c678dd;">print</span>(add_output)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Example: Run a Python script using Poetry</span>
<span style="color: #dcaeea;">run_script_command</span> = <span style="color: #98be65;">"poetry run python my_script.py"</span>
<span style="color: #dcaeea;">run_script_output</span> = run_poetry_command(run_script_command)
<span style="color: #c678dd;">print</span>(run_script_output)


</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">from</span> astropy.io <span style="color: #51afef;">import</span> fits
<span style="color: #51afef;">import</span> numpy <span style="color: #51afef;">as</span> np
<span style="color: #51afef;">from</span> maskfill <span style="color: #51afef;">import</span> maskfill <span style="color: #5B6268;">#</span><span style="color: #5B6268;">download from github NOT pip</span>
<span style="color: #51afef;">import</span> matplotlib.pyplot <span style="color: #51afef;">as</span> plt
<span style="color: #51afef;">from</span> astropy.visualization <span style="color: #51afef;">import</span> astropy_mpl_style

<span style="color: #51afef;">for</span> i <span style="color: #51afef;">in</span> x:
    <span style="color: #dcaeea;">hdul</span> = fits.<span style="color: #c678dd;">open</span>(<span style="color: #98be65;">"galactic_center_masked_{}.fits"</span>.<span style="color: #c678dd;">format</span>(i))
    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Get the data from the FITS file</span>
    <span style="color: #dcaeea;">data</span> = hdul[<span style="color: #da8548; font-weight: bold;">0</span>].data

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Create a masked array from the data, masking NaN values</span>
    <span style="color: #dcaeea;">masked_data</span> = np.ma.masked_invalid(data)

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Access the mask array</span>
    <span style="color: #dcaeea;">mask_array</span> = masked_data.mask

    maskfill.maskfill(data, mask_array,writesteps=<span style="color: #a9a1e1;">False</span>,output_file=<span style="color: #98be65;">'maskfilled/filled_{}.fits'</span>.<span style="color: #c678dd;">format</span>(i),verbose=<span style="color: #a9a1e1;">True</span>)

</pre>
</div>



<div id="org377174d" class="figure">
<p><img src="./visualizations/Maskfill.png" alt="Maskfill.png" />
</p>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">Comparison</th>
<th scope="col" class="org-right">MSE</th>
<th scope="col" class="org-right">SSIM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0.0</td>
<td class="org-right">0.0</td>
<td class="org-right">1.0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">10.0</td>
<td class="org-right">169.59955577168992</td>
<td class="org-right">0.8406528055948019</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">20.0</td>
<td class="org-right">150.39562244550564</td>
<td class="org-right">0.8853538258497918</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">30.0</td>
<td class="org-right">140.01027954791735</td>
<td class="org-right">0.9101794531835622</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">40.0</td>
<td class="org-right">125.39866935548982</td>
<td class="org-right">0.9334534610339772</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgcf5c7d1" class="outline-2">
<h2 id="orgcf5c7d1"><span class="section-number-2">5.</span> R-INLA</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load necessary packages</span>
<span style="color: #a9a1e1;">library</span>(INLA)
<span style="color: #a9a1e1;">library</span>(FITSio)
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Read fits image</span>
fits_data <span style="color: #a9a1e1;">&lt;-</span> readFITS(<span style="color: #98be65;">"galactic_center.fits"</span>)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define spatial mesh</span>
x <span style="color: #a9a1e1;">&lt;-</span> seq(<span style="color: #da8548; font-weight: bold;">1</span>, ncol(fits_data))
y <span style="color: #a9a1e1;">&lt;-</span> seq(<span style="color: #da8548; font-weight: bold;">1</span>, nrow(fits_data)

mesh <span style="color: #a9a1e1;">&lt;-</span> inla.mesh.2d(x, y, max.n = <span style="color: #da8548; font-weight: bold;">10</span>, cutoff = cutoff)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define model</span>
formula <span style="color: #a9a1e1;">&lt;-</span> observed_data ~ f(mesh, model = <span style="color: #98be65;">"rw2"</span>)

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Define likelihood</span>
likelihood <span style="color: #a9a1e1;">&lt;-</span> <span style="color: #98be65;">"gaussian"</span>

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Fit the model</span>
fit <span style="color: #a9a1e1;">&lt;-</span> inla(formula, data = list(observed_data = fits_data),
            control.predictor = list(compute = <span style="color: #ECBE7B;">TRUE</span>),
            control.inla = list(strategy = <span style="color: #98be65;">"adaptive"</span>))

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">Posterior prediction</span>
predicted_image <span style="color: #a9a1e1;">&lt;-</span> fitted(fit)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf051711" class="outline-2">
<h2 id="orgf051711"><span class="section-number-2">6.</span> Comparisons</h2>
<div class="outline-text-2" id="text-6">
<ol class="org-ol">
<li><b><b>Mean Squared Error (MSE)</b></b>:
<ul class="org-ul">
<li>Mean Squared Error is a commonly used metric to measure the average squared difference between the original and the masked images. It quantifies the average of the squares of the errors or deviations. A lower MSE value indicates a closer resemblance between the two images.</li>
<li><p>
The formula for MSE between two images A and B, each with dimensions \(m \times n\), is:
</p>

<p>
\[
     MSE = \frac{1}{mn} \sum_{i=0}^{m-1} \sum_{j=0}^{n-1} (A_{ij} - B_{ij})^2
     \]
</p></li>
</ul></li>

<li><b><b>Structural Similarity Index (SSIM)</b></b>:
<ul class="org-ul">
<li>SSIM is a perception-based metric that measures the similarity between two images. It considers luminance, contrast, and structure. Unlike MSE, SSIM takes into account the structure of the images, making it more suitable for assessing perceptual differences.</li>
<li>The SSIM index ranges from -1 to 1, where 1 indicates perfect similarity. Typically, a value above 0.9 is considered a good match.</li>
<li><p>
The SSIM index formula involves comparisons between local neighborhoods of the images&rsquo; pixels. The formula for SSIM index between images A and B is:
</p>

<p>
\[
     SSIM(A, B) = \frac{(2 \mu_A \mu_B + C_1)(2 \sigma_{AB} + C_2)}{(\mu_A^2 + \mu_B^2 + C_1)(\sigma_A^2 + \sigma_B^2 + C_2)}
     \]
</p>

<p>
Here,
</p>
<ul class="org-ul">
<li>\(\mu_A\) and \(\mu_B\) are the means of images A and B,</li>
<li>\(\sigma_A^2\) and \(\sigma_B^2\) are the variances of images A and B,</li>
<li>\(\sigma_{AB}\) is the covariance of images A and B,</li>
<li>\(C_1\) and \(C_2\) are small constants to prevent division by zero errors and stabilize the division, and</li>
<li>\(L\) is the dynamic range of pixel values (typically \(2^{\text{bitdepth}} - 1\) for images with bit depth).</li>
</ul></li>
</ul></li>
</ol>
</div>
<div id="outline-container-org7bd2ccd" class="outline-3">
<h3 id="org7bd2ccd"><span class="section-number-3">6.1.</span> Astropy conv</h3>
<div class="outline-text-3" id="text-6-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">Comparison</th>
<th scope="col" class="org-right">MSE</th>
<th scope="col" class="org-right">SSIM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0.0</td>
<td class="org-right">41.31836383457224</td>
<td class="org-right">0.9542151726989633</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">10.0</td>
<td class="org-right">175.0253853352854</td>
<td class="org-right">0.8284485435865382</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">20.0</td>
<td class="org-right">156.0987621112356</td>
<td class="org-right">0.8674916390963295</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">30.0</td>
<td class="org-right">146.6109666965225</td>
<td class="org-right">0.8866031019110286</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">40.0</td>
<td class="org-right">135.1704353934664</td>
<td class="org-right">0.9033264570664562</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgdae72e6" class="outline-3">
<h3 id="orgdae72e6"><span class="section-number-3">6.2.</span> Astropy fft</h3>
<div class="outline-text-3" id="text-6-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">Comparison</th>
<th scope="col" class="org-right">MSE</th>
<th scope="col" class="org-right">SSIM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0.0</td>
<td class="org-right">41.31836383457224</td>
<td class="org-right">0.9542151726989633</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">10.0</td>
<td class="org-right">175.0253853352854</td>
<td class="org-right">0.8284485435865382</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">20.0</td>
<td class="org-right">156.0987621112356</td>
<td class="org-right">0.8674916390963295</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">30.0</td>
<td class="org-right">146.6109666965225</td>
<td class="org-right">0.8866031019110286</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">40.0</td>
<td class="org-right">135.1704353934664</td>
<td class="org-right">0.9033264570664562</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgd936091" class="outline-3">
<h3 id="orgd936091"><span class="section-number-3">6.3.</span> Maskfill</h3>
<div class="outline-text-3" id="text-6-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">&#xa0;</th>
<th scope="col" class="org-right">Comparison</th>
<th scope="col" class="org-right">MSE</th>
<th scope="col" class="org-right">SSIM</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-right">0.0</td>
<td class="org-right">0.0</td>
<td class="org-right">1.0</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">10.0</td>
<td class="org-right">169.59955577168992</td>
<td class="org-right">0.8406528055948019</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">20.0</td>
<td class="org-right">150.39562244550564</td>
<td class="org-right">0.8853538258497918</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">30.0</td>
<td class="org-right">140.01027954791735</td>
<td class="org-right">0.9101794531835622</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">40.0</td>
<td class="org-right">125.39866935548982</td>
<td class="org-right">0.9334534610339772</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: dp</p>
<p class="date">Created: 2024-03-22 Παρ 02:40</p>
</div>
</body>
</html>
